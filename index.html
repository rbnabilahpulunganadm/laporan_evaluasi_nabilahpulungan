<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Kinerja Klinik - Advanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .file-upload-card { transition: all 0.3s ease; }
        .file-upload-card.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        .hidden { display: none; }
        .stat-card, .chart-container { animation: fadeIn 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        #dashboardContainer.loaded .stat-card:nth-child(1) { animation-delay: 0.1s; }
        #dashboardContainer.loaded .stat-card:nth-child(2) { animation-delay: 0.2s; }
        #dashboardContainer.loaded .stat-card:nth-child(3) { animation-delay: 0.3s; }
        #dashboardContainer.loaded .stat-card:nth-child(4) { animation-delay: 0.4s; }
        #dashboardContainer.loaded .stat-card:nth-child(5) { animation-delay: 0.5s; }
        #dashboardContainer.loaded .stat-card:nth-child(6) { animation-delay: 0.6s; }
        #dashboardContainer.loaded .chart-container { animation-delay: calc(0.5s + (var(--chart-index) * 0.1s)); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        canvas { width: 100% !important; height: 350px !important; }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Laporan Kinerja Klinik (Advanced)</h1>
            <p class="text-gray-500 mt-1">Unggah file data Anda untuk membuat laporan analisis mendalam.</p>
        </header>

        <div id="uploadSection" class="mb-8 p-6 bg-white rounded-2xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Langkah 1: Unggah File Data Anda (.csv)</h2>
            <div id="fileInputs" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="file-upload-card border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <label for="reservasiFile" class="cursor-pointer"><i data-lucide="calendar-check" class="w-12 h-12 mx-auto text-blue-500"></i><p class="mt-2 font-semibold text-gray-700">Data Reservasi</p><p class="text-sm text-gray-500" id="reservasiFileName">Klik atau seret file</p></label>
                    <input type="file" id="reservasiFile" class="hidden" accept=".csv">
                </div>
                <div class="file-upload-card border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <label for="bidanFile" class="cursor-pointer"><i data-lucide="clipboard-list" class="w-12 h-12 mx-auto text-yellow-500"></i><p class="mt-2 font-semibold text-gray-700">Aktivitas Bidan</p><p class="text-sm text-gray-500" id="bidanFileName">Klik atau seret file</p></label>
                    <input type="file" id="bidanFile" class="hidden" accept=".csv">
                </div>
                <div class="file-upload-card border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <label for="pelangganFile" class="cursor-pointer"><i data-lucide="users" class="w-12 h-12 mx-auto text-purple-500"></i><p class="mt-2 font-semibold text-gray-700">Data Pelanggan</p><p class="text-sm text-gray-500" id="pelangganFileName">Klik atau seret file</p></label>
                    <input type="file" id="pelangganFile" class="hidden" accept=".csv">
                </div>
                <div class="file-upload-card border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <label for="absensiFile" class="cursor-pointer"><i data-lucide="user-check" class="w-12 h-12 mx-auto text-teal-500"></i><p class="mt-2 font-semibold text-gray-700">Data Absensi Bidan</p><p class="text-sm text-gray-500" id="absensiFileName">Klik atau seret file</p></label>
                    <input type="file" id="absensiFile" class="hidden" accept=".csv">
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="generateReportBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">Buat Laporan</button>
            </div>
            <p id="uploadStatus" class="text-center mt-4 text-red-500"></p>
        </div>

        <div id="dashboardContainer" class="hidden">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                 <div class="stat-card bg-white p-6 rounded-2xl shadow-lg border-l-4 border-blue-500"><div class="flex items-center"><div class="p-3 bg-blue-100 rounded-full"><i data-lucide="book-marked" class="w-6 h-6 text-blue-600"></i></div><div class="ml-4"><p class="text-sm text-gray-500 font-medium">Total Reservasi</p><p id="totalReservasi" class="text-2xl font-bold">0</p></div></div></div>
                <div class="stat-card bg-white p-6 rounded-2xl shadow-lg border-l-4 border-green-500"><div class="flex items-center"><div class="p-3 bg-green-100 rounded-full"><i data-lucide="wallet" class="w-6 h-6 text-green-600"></i></div><div class="ml-4"><p class="text-sm text-gray-500 font-medium">Total Pendapatan</p><p id="totalPendapatan" class="text-2xl font-bold">0</p></div></div></div>
                <div class="stat-card bg-white p-6 rounded-2xl shadow-lg border-l-4 border-yellow-500"><div class="flex items-center"><div class="p-3 bg-yellow-100 rounded-full"><i data-lucide="clipboard-list" class="w-6 h-6 text-yellow-600"></i></div><div class="ml-4"><p class="text-sm text-gray-500 font-medium">Total Aktivitas</p><p id="totalAktivitas" class="text-2xl font-bold">0</p></div></div></div>
                <div class="stat-card bg-white p-6 rounded-2xl shadow-lg border-l-4 border-purple-500"><div class="flex items-center"><div class="p-3 bg-purple-100 rounded-full"><i data-lucide="users" class="w-6 h-6 text-purple-600"></i></div><div class="ml-4"><p class="text-sm text-gray-500 font-medium">Bidan Aktif</p><p id="jumlahBidan" class="text-2xl font-bold">0</p></div></div></div>
                <div class="stat-card bg-white p-6 rounded-2xl shadow-lg border-l-4 border-teal-500"><div class="flex items-center"><div class="p-3 bg-teal-100 rounded-full"><i data-lucide="calendar-check-2" class="w-6 h-6 text-teal-600"></i></div><div class="ml-4"><p class="text-sm text-gray-500 font-medium">Tingkat Kehadiran</p><p id="tingkatKehadiran" class="text-2xl font-bold">0%</p></div></div></div>
                <div class="stat-card bg-white p-6 rounded-2xl shadow-lg border-l-4 border-orange-500"><div class="flex items-center"><div class="p-3 bg-orange-100 rounded-full"><i data-lucide="clock" class="w-6 h-6 text-orange-600"></i></div><div class="ml-4"><p class="text-sm text-gray-500 font-medium">Ketepatan Waktu</p><p id="ketepatanWaktu" class="text-2xl font-bold">0%</p></div></div></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="chart-container bg-white p-6 rounded-2xl shadow-lg" style="--chart-index: 1;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Analisis Tren Reservasi</h3>
                        <select id="trendFilter" class="border border-gray-300 rounded-md p-1.5 text-sm">
                            <option value="keseluruhan">Tren Keseluruhan</option>
                            <option value="treatment">Perbandingan per Treatment</option>
                            <option value="terapis">Perbandingan per Terapis</option>
                        </select>
                    </div>
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="chart-container bg-white p-6 rounded-2xl shadow-lg" style="--chart-index: 2;"><h3 class="text-lg font-semibold mb-4">Treatment Terpopuler (Detail)</h3><canvas id="treatmentChart"></canvas></div>
                <div class="chart-container bg-white p-6 rounded-2xl shadow-lg" style="--chart-index: 3;"><h3 class="text-lg font-semibold mb-4">Jam Kedatangan Terbanyak</h3><canvas id="jamChart"></canvas></div>
                <div class="chart-container bg-white p-6 rounded-2xl shadow-lg" style="--chart-index: 4;"><h3 class="text-lg font-semibold mb-4">Hari Kedatangan Terbanyak</h3><canvas id="hariChart"></canvas></div>
                <div class="chart-container bg-white p-6 rounded-2xl shadow-lg" style="--chart-index: 5;"><h3 class="text-lg font-semibold mb-4">Statistik Kehadiran per Bidan</h3><canvas id="absensiChart"></canvas></div>
                <div class="chart-container bg-white p-6 rounded-2xl shadow-lg" style="--chart-index: 6;"><h3 class="text-lg font-semibold mb-4">Distribusi Gender Pasien</h3><div class="flex justify-center items-center h-full"><canvas id="genderChart" style="max-height: 300px; max-width: 300px;"></canvas></div></div>
            </div>
        </div>
        
        <footer class="text-center mt-12 text-gray-500"><p>&copy; 2025 Laporan Kinerja Otomatis. Dibuat untuk presentasi.</p></footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const fileInputs = { reservasi: document.getElementById('reservasiFile'), bidan: document.getElementById('bidanFile'), pelanggan: document.getElementById('pelangganFile'), absensi: document.getElementById('absensiFile') };
            const fileNames = { reservasi: document.getElementById('reservasiFileName'), bidan: document.getElementById('bidanFileName'), pelanggan: document.getElementById('pelangganFileName'), absensi: document.getElementById('absensiFileName') };
            const generateBtn = document.getElementById('generateReportBtn');
            const uploadStatus = document.getElementById('uploadStatus');
            const dashboardContainer = document.getElementById('dashboardContainer');
            const trendFilter = document.getElementById('trendFilter');
            const chartInstances = {};
            let masterData = {};

            const setupDragAndDrop = (card, input, nameEl) => {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => card.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }));
                card.addEventListener('dragenter', () => card.classList.add('dragover'));
                card.addEventListener('dragleave', () => card.classList.remove('dragover'));
                card.addEventListener('drop', e => {
                    card.classList.remove('dragover');
                    input.files = e.dataTransfer.files;
                    input.dispatchEvent(new Event('change'));
                });
            };

            for (const key in fileInputs) {
                const input = fileInputs[key];
                const nameEl = fileNames[key];
                const card = input.closest('.file-upload-card');
                input.addEventListener('change', () => {
                    if (input.files && input.files.length > 0) {
                        nameEl.textContent = input.files[0].name;
                        nameEl.classList.add('text-green-600', 'font-semibold');
                    } else {
                        nameEl.textContent = 'Klik atau seret file';
                        nameEl.classList.remove('text-green-600', 'font-semibold');
                    }
                });
                setupDragAndDrop(card, input, nameEl);
            }

            const parseFile = (file) => new Promise((resolve, reject) => {
                if (!file) return reject(new Error("File tidak ditemukan."));
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: res => resolve(res.data), error: err => reject(err) });
            });

            generateBtn.addEventListener('click', async () => {
                uploadStatus.textContent = '';
                if (Object.values(fileInputs).some(input => !input.files[0])) {
                    uploadStatus.textContent = 'Harap unggah keempat file yang diperlukan.';
                    return;
                }
                
                generateBtn.disabled = true;
                generateBtn.textContent = 'Memproses...';

                try {
                    const [reservasi, bidan, pelanggan, absensi] = await Promise.all([
                        parseFile(fileInputs.reservasi.files[0]),
                        parseFile(fileInputs.bidan.files[0]),
                        parseFile(fileInputs.pelanggan.files[0]),
                        parseFile(fileInputs.absensi.files[0]),
                    ]);
                    masterData = { reservasi, bidan, pelanggan, absensi };
                    renderDashboard(masterData);
                    dashboardContainer.classList.remove('hidden');
                    dashboardContainer.classList.add('loaded');
                    window.scrollTo({ top: document.getElementById('uploadSection').offsetHeight, behavior: 'smooth' });
                } catch (error) {
                    console.error("Gagal memproses file:", error);
                    uploadStatus.textContent = `Terjadi kesalahan: ${error.message}`;
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Buat Laporan';
                }
            });

            trendFilter.addEventListener('change', () => updateTrendChart(masterData.reservasi));
            
            const destroyCharts = () => Object.values(chartInstances).forEach(chart => chart && chart.destroy());

            const PALETTE = ['#3b82f6', '#10b981', '#eab308', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1'];

            const renderDashboard = ({ reservasi, bidan, pelanggan, absensi }) => {
                destroyCharts();
                
                // Stat Cards
                document.getElementById('totalReservasi').textContent = reservasi.length.toLocaleString('id-ID');
                document.getElementById('totalPendapatan').textContent = `Rp ${reservasi.reduce((s, i) => s + (parseInt(i.Tarif) || 0), 0).toLocaleString('id-ID')}`;
                document.getElementById('totalAktivitas').textContent = bidan.length.toLocaleString('id-ID');
                document.getElementById('jumlahBidan').textContent = new Set(bidan.map(i => i['Nama Bidan'])).size.toLocaleString('id-ID');

                const hadirCount = absensi.filter(i => i.Status && i.Status.toLowerCase() === 'hadir').length;
                const tepatWaktuCount = absensi.filter(i => i.Keterlambatan && i.Keterlambatan.toLowerCase() === 'tepat waktu').length;
                document.getElementById('tingkatKehadiran').textContent = `${absensi.length > 0 ? ((hadirCount / absensi.length) * 100).toFixed(0) : 0}%`;
                document.getElementById('ketepatanWaktu').textContent = `${hadirCount > 0 ? ((tepatWaktuCount / hadirCount) * 100).toFixed(0) : 0}%`;

                updateTrendChart(reservasi);
                
                // Treatment Chart
                const treatmentCounts = reservasi.reduce((acc, { Treatments }) => { if (Treatments) acc[Treatments] = (acc[Treatments] || 0) + 1; return acc; }, {});
                const sortedTreatments = Object.entries(treatmentCounts).sort(([,a],[,b]) => b-a).slice(0, 10);
                chartInstances.treatment = new Chart(document.getElementById('treatmentChart').getContext('2d'), { type: 'bar', data: { labels: sortedTreatments.map(i => i[0]), datasets: [{ label: 'Jumlah', data: sortedTreatments.map(i => i[1]), backgroundColor: PALETTE[1] }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });

                // Jam Chart
                const jamCounts = reservasi.reduce((acc, { ['Jam Booking']: jam }) => { if (jam) { const hour = jam.split(':')[0]; acc[hour] = (acc[hour] || 0) + 1; } return acc; }, {});
                const sortedJam = Object.entries(jamCounts).sort((a,b) => parseInt(a[0]) - parseInt(b[0]));
                chartInstances.jam = new Chart(document.getElementById('jamChart').getContext('2d'), { type: 'bar', data: { labels: sortedJam.map(i => `${i[0]}:00`), datasets: [{ label: 'Jumlah Reservasi', data: sortedJam.map(i => i[1]), backgroundColor: PALETTE[2] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });

                // Hari Chart
                const hariLabels = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                const hariCounts = reservasi.reduce((acc, { ['Tgl Booking']: tgl }) => { if (tgl) { const day = new Date(tgl).getDay(); acc[day] = (acc[day] || 0) + 1; } return acc; }, Array(7).fill(0));
                chartInstances.hari = new Chart(document.getElementById('hariChart').getContext('2d'), { type: 'bar', data: { labels: hariLabels, datasets: [{ label: 'Jumlah Reservasi', data: hariCounts, backgroundColor: PALETTE[3] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });

                // Absensi Chart
                const absensiByBidan = absensi.reduce((acc, { Nama, Keterlambatan }) => {
                    if (!Nama) return acc;
                    if (!acc[Nama]) acc[Nama] = { tepat: 0, telat: 0 };
                    Keterlambatan && Keterlambatan.toLowerCase() === 'tepat waktu' ? acc[Nama].tepat++ : acc[Nama].telat++;
                    return acc;
                }, {});
                chartInstances.absensi = new Chart(document.getElementById('absensiChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(absensiByBidan), datasets: [{ label: 'Tepat Waktu', data: Object.values(absensiByBidan).map(d => d.tepat), backgroundColor: PALETTE[5] }, { label: 'Terlambat', data: Object.values(absensiByBidan).map(d => d.telat), backgroundColor: PALETTE[6] }] }, options: { scales: { x: { stacked: true }, y: { stacked: true } }, responsive: true, maintainAspectRatio: false } });

                // Gender Chart
                const genderCounts = pelanggan.reduce((acc, { Gender }) => { if (Gender) acc[Gender] = (acc[Gender] || 0) + 1; return acc; }, {});
                chartInstances.gender = new Chart(document.getElementById('genderChart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(genderCounts), datasets: [{ data: Object.values(genderCounts), backgroundColor: [PALETTE[0], PALETTE[4], PALETTE[2]], borderWidth: 4, borderColor: '#ffffff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            };

            const updateTrendChart = (reservasiData) => {
                if (chartInstances.trend) chartInstances.trend.destroy();
                const filter = trendFilter.value;

                const dates = [...new Set(reservasiData.map(i => i['Tgl Booking']).filter(Boolean))].sort();
                let datasets = [];

                if (filter === 'keseluruhan') {
                    const counts = dates.map(date => reservasiData.filter(i => i['Tgl Booking'] === date).length);
                    datasets.push({ label: 'Total Reservasi', data: counts, borderColor: PALETTE[0], tension: 0.1, fill: false });
                } else {
                    const key = filter === 'treatment' ? 'Treatments' : 'Terapis';
                    const counts = reservasiData.reduce((acc, item) => { if (item[key]) acc[item[key]] = (acc[item[key]] || 0) + 1; return acc; }, {});
                    const topItems = Object.entries(counts).sort(([,a],[,b]) => b-a).slice(0, 5).map(i => i[0]);
                    
                    topItems.forEach((item, index) => {
                        const itemCounts = dates.map(date => reservasiData.filter(i => i['Tgl Booking'] === date && i[key] === item).length);
                        datasets.push({ label: item, data: itemCounts, borderColor: PALETTE[index % PALETTE.length], tension: 0.1, fill: false });
                    });
                }

                chartInstances.trend = new Chart(document.getElementById('trendChart').getContext('2d'), { type: 'line', data: { labels: dates, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } } } } });
            };
        });
    </script>
</body>
</html>

